<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.js"></script>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .button {
            background: #0066ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .project-list {
            margin-top: 20px;
            overflow-y: auto;
        }
        .project-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
            cursor: pointer;
        }
        .project-card:hover {
            background: #f0f0f0;
        }
        .editor-container {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        .editor-header {
            padding: 10px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-tabs {
            display: flex;
            background: #f5f5f5;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .file-tab {
            padding: 5px 15px;
            margin-right: 5px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .file-tab.active {
            background: white;
            border-bottom: 2px solid #0066ff;
        }
        #monaco-editor {
            flex: 1;
            min-height: 500px;
        }
        .preview-container {
            display: none;
            height: 300px;
            border-top: 1px solid #ddd;
        }
        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Web App Creator</h2>
        <button class="button" onclick="createProject()">New Project</button>
        <div id="projectList" class="project-list"></div>
    </div>

    <div class="main-content">
        <div id="editorContainer" class="editor-container">
            <div class="editor-header">
                <h3 id="currentProjectName"></h3>
                <div>
                    <button class="button" onclick="saveCurrentFile()">Save</button>
                    <button class="button" onclick="togglePreview()">Preview</button>
                </div>
            </div>
            <div id="fileTabs" class="file-tabs"></div>
            <div id="monaco-editor"></div>
            <div id="previewContainer" class="preview-container">
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </div>

    <script>
        let editor;
        let currentProject = null;
        let currentFile = null;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                theme: 'vs',
                automaticLayout: true,
                minimap: { enabled: false }
            });
        });

        async function createProject() {
            const name = prompt('Enter project name:');
            if (name) {
                try {
                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, type: 'static' })
                    });
                    if (response.ok) {
                        loadProjects();
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                const list = document.getElementById('projectList');
                list.innerHTML = projects.map(project => `
                    <div class="project-card" onclick="openProject('${project.id}', '${project.name}')">
                        <h3>${project.name}</h3>
                        <p>Type: ${project.type}</p>
                        <p>Created: ${new Date(project.created).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function openProject(id, name) {
            currentProject = id;
            document.getElementById('currentProjectName').textContent = name;
            document.getElementById('editorContainer').style.display = 'flex';
            
            try {
                const response = await fetch(`/api/projects/${id}/files`);
                const { files } = await response.json();
                showFileTabs(files);
                if (files.length > 0) {
                    openFile(files[0]);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showFileTabs(files) {
            const tabs = document.getElementById('fileTabs');
            tabs.innerHTML = files.map(file => `
                <button class="file-tab" onclick="openFile('${file}')">${file}</button>
            `).join('');
        }

        async function openFile(filename) {
            try {
                const response = await fetch(`/api/projects/${currentProject}/files/${filename}`);
                const { content } = await response.json();
                editor.setValue(content);
                currentFile = filename;
                
                // Update tab highlighting
                document.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.textContent === filename);
                });

                // Set language based on file extension
                const ext = filename.split('.').pop();
                const language = {
                    'js': 'javascript',
                    'html': 'html',
                    'css': 'css'
                }[ext] || 'plaintext';
                monaco.editor.setModelLanguage(editor.getModel(), language);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function saveCurrentFile() {
            if (!currentProject || !currentFile) return;
            
            try {
                await fetch(`/api/projects/${currentProject}/files/${currentFile}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() })
                });
                alert('File saved!');
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving file');
            }
        }

        function togglePreview() {
            const container = document.getElementById('previewContainer');
            const isVisible = container.style.display === 'block';
            container.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible && currentProject) {
                const frame = document.getElementById('preview-frame');
                frame.src = `/projects/${currentProject}/index.html`;
            }
        }

        // Load projects on page load
        loadProjects();
    </script>
</body>
</html>
